# Objective

Create a basic virtual malware lab on using VitualBox on a laptop.


An isolated network will be used for guest communication. One of the guests will act as a gateway/firewall and connect the isolated network to the internet via NAT.


The guests will include base machines, which will then be used to create multiple linked clones.

# Rationale for not using vlabs
- performance: no network lag
- usability: native rendering instead of browser rendering
- networking: vlabs have no internet access
- get to keep setup after course is over
- learn to setup lab
- learn virtualbox

# Architecture
![net](net.png)

# Hardware
A 5 year old dell laptop, with taped up microphone and camera.
- quad-core i7
- 8gb DDR3
- 128GB SSD

# BIOS
Ensure disabled
- usb
- com
- lpt
- bluetooth
- C-steps

Ensure enabled
- virtualization









# Host OS
Ubuntu 16.04.1

## Download
http://releases.ubuntu.com/xenial/ubuntu-16.04-desktop-amd64.iso

## Install
- Burn iso and boot
- do not tick the "install third party stuff" checkbox
- auto partitioning
  - full disk encryption using LVM
  - 500MB unencrypted "/boot" partition
  - 117GB encrypted "/" partition
  - 8GB encrypted swap

## Configure
Set up aliases
```
echo "alias canihaz='sudo apt-get install'" >> ~/.bashrc
echo "alias updates='sudo apt-get update && sudo apt-get upgrade -y'" >> ~/.bashrc
etc...
```

Set up networking
- disable ipv6 on eth0

Flick through control panel
  - edit leaky "privacy and security" settings
  - aggressive update settings, but no dist-upgrade
  - adjust power settings

Install
  - updates
    - ```updates```
  - VirtualBox
    - ```canihaz virtualbox```
  - IDS
    - Not sure here.
    - TripWire is commercial.
    - OSSEC requires server?

# Guests
- 1 x Remnux (gateway) - 64-bit
- 2 x Kali (helpers) - 64-bit
- 2 x Windows 7 (victims) - 32-bit

# Networking reference
Remnux
- eth0
  - NAT / DHCP
- eth1
  - 192.168.3.1
  - 255.255.255.0
  - intnet

Kali 1
- 192.168.3.101
- 255.255.255.0
- intnet

Kali 2
- 192.168.3.102
- 255.255.255.0
- intnet

Victim 1
- 192.168.3.201
- 255.255.255.0
- intnet

Victim 2
- 192.168.3.202
- 255.255.255.0
- intnet

# Download guests
- https://docs.google.com/uc?id=0B6fULLT_NpxMampUWlBCQXVJZzA&export=download
- http://cdimage.kali.org/kali-2016.2/
- http://www.robertmcardle.com/Teaching/VM/






# Install remnux

## Import OVA/OVF file
![net](images/remnux_1.png)
![net](images/remnux_2.png)

## Set up network interfaces
![net](images/remnux_3.png)
![net](images/remnux_4.png)

## Take snapshot
![net](images/remnux_5.png)

## Configure
- install virtualbox guest additions [command in footnote]
- enable port forwarding https://unix.stackexchange.com/questions/126595/iptables-forward-all-traffic-to-interface
- set up networking, edit:

#### /etc/network/interfaces
```
# Loopback interface
auto lo
iface lo inet loopback

# Internet
auto eth0
iface eth0 inet dhcp

# Internal Network
auto eth1
iface eth1 inet static
  address 192.168.3.1
  netmask 255.255.255.0
```

- shutdown
- take another snapshot







# Install Kalis
## create new VM
![net](images/kali_1.png)

## set up disk
![net](images/kali_2.png)

## set up networking
![net](images/kali_3.png)

## attach iso to optical drive
![net](images/kali_4.png)

## boot
![net](images/kali_5.png)

## default install, skip networking
![net](images/kali_6.png)

- reboot
- install updates
- shutdown
- take snapshot

## Disable screensaver
![net](images/kali_9.png)

## Configure
- install virtualbox guest additions [command in footnote]
- shutdown
- take snapshot

## create linked clones
![net](images/kali_7.png)
![net](images/kali_8.png)

## Configure networking on linked clones
![net](images/kali_10.png)
![net](images/kali_11.png)








# Install victims
## delete manifest file, otherwise, you will get the below error
![net](images/victim_1.png)

## Set up network interface
![net](images/victim_2.png)

## Other config
- add optical drive in virtualbox
- reduce RAM from 3GB to 2.5GB

## Install
- Import OVA/OVF file

## Configure
- install virtualbox guest additions
- reduce font size to 100%
- shutdown
- take snapshot
- create linked clones

## Configure networking on linked clones
![net](images/victim_3.png)
![net](images/victim_4.png)
- shutdown
- take snapshot




# Done
This is what I ended up with

![net](images/done_1.png)
![net](images/done_2.png)
![net](images/done_3.png)
![net](images/done_4.png)

### Watch out
The memory gets eaten up rather quick with the number of running vms and the host might become unresponsive and/or die.
![net](images/done_5.png)


# Footnotes
[Install VirtualBox additions on linux]
```
mount additions image (devices -> insert guess additions cd)
cd /media/cdrom0
cp VBoxLinuxAdditions.run ~
cd ~
chmod +x VBoxLinuxAdditions.run
./VBoxLinuxAdditions.run
sudo reboot
```